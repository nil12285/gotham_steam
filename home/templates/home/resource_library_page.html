{% extends "base.html" %}
{% load static wagtailcore_tags %}

{% block title %}Opportunity Search{% endblock %}

{% block content %}
<div class="container-fluid bg-light-purple py-5">
    <div class="container text-white">
        <h1 class="display-4 fw-bold">Explore STEM Opportunities</h1>
        <p class="lead">{{ page.intro|default:"Find the perfect program, resource, or activity based on your interests,
            age group, and location." }}</p>
    </div>
</div>

<div class="container my-5">
    <div class="row">

        {# --- 1. FILTER SIDEBAR (LEFT) --- #}
        <div class="col-lg-3">
            <div class="card shadow-sm p-4 sticky-top" style="top: 20px;">
                <h5 class="fw-bold mb-3 border-bottom pb-2">Filter by Criteria</h5>

                <form id="opportunity-filter-form">

                    {# Search Bar #}
                    <div class="mb-4">
                        <label for="search-text" class="form-label fw-bold">Search Keywords</label>
                        <input type="text" id="search-text" class="form-control"
                            placeholder="E.g., Robotics, Brooklyn...">
                    </div>

                    {# Program Type Filter (e.g., Preschool, High School) #}
                    <div class="mb-4">
                        <label class="form-label fw-bold">Program Type</label>
                        {% for choice_key, choice_display in program_choices %}
                        <div class="form-check">
                            <input class="form-check-input filter-input" type="checkbox" value="{{ choice_key }}"
                                id="program-{{ choice_key }}" data-filter-group="program_type">
                            <label class="form-check-label" for="program-{{ choice_key }}">
                                {{ choice_display }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>

                    {# Location Type Filter (Online/Offline) #}
                    <div class="mb-4">
                        <label class="form-label fw-bold">Location Type</label>
                        <div class="form-check">
                            <input class="form-check-input filter-input" type="radio" name="online_offline"
                                value="online" id="location-online">
                            <label class="form-check-label" for="location-online">Online Only</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input filter-input" type="radio" name="online_offline"
                                value="offline" id="location-offline">
                            <label class="form-check-label" for="location-offline">Offline Only</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input filter-input" type="radio" name="online_offline" value="all"
                                id="location-all" checked>
                            <label class="form-check-label" for="location-all">All Locations</label>
                        </div>
                    </div>

                    {# Fees Filter #}
                    <div class="mb-4">
                        <label class="form-label fw-bold">Fees</label>
                        <div class="form-check">
                            <input class="form-check-input filter-input" type="radio" name="fees" value="free"
                                id="fees-free">
                            <label class="form-check-label" for="fees-free">Free Only</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input filter-input" type="radio" name="fees" value="paid"
                                id="fees-paid">
                            <label class="form-check-label" for="fees-paid">Paid Only</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input filter-input" type="radio" name="fees" value="all"
                                id="fees-all" checked>
                            <label class="form-check-label" for="fees-all">Any Fees</label>
                        </div>
                    </div>

                    {# Reset Button #}
                    <button type="reset" class="btn btn-outline-secondary w-100 mt-3">Clear Filters</button>

                </form>
            </div>
        </div>

        {# --- 2. OPPORTUNITY LIST (RIGHT) --- #}
        <div class="col-lg-9">
            <h4 class="mb-4"><span id="result-count">0</span> Opportunities Found</h4>
            <div id="opportunity-list" class="row g-4">
                {# Opportunity Cards will be injected here by JavaScript #}
                <div id="loading-spinner" class="text-center p-5 d-none">
                    <div class="spinner-border text-primary-green" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>

            {# Empty Results Message #}
            <div id="no-results" class="alert alert-info mt-5 d-none">
                No opportunities match your current filters. Try broadening your search criteria.
            </div>

        </div>
    </div>
</div>

<script type="module">
    // --- FIREBASE SETUP ---
    // Firestore imports are handled in the base.html for the whole site
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('Debug');

    // Global variables (provided by Canvas environment)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let db;
    let auth;
    let userId = null;
    let opportunitiesCollectionRef = null;

    // UI elements
    const opportunityList = document.getElementById('opportunity-list');
    const resultCount = document.getElementById('result-count');
    const filterForm = document.getElementById('opportunity-filter-form');
    const noResultsMessage = document.getElementById('no-results');
    const loadingSpinner = document.getElementById('loading-spinner');
    const searchText = document.getElementById('search-text');

    // Debounce function to limit query frequency
    function debounce(func, delay) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---
    async function initializeFirebase() {
        if (!Object.keys(firebaseConfig).length) {
            console.error("Firebase configuration is missing.");
            return;
        }

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        try {
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
            userId = auth.currentUser?.uid || crypto.randomUUID();
            console.log("Firebase initialized and authenticated. User ID:", userId);

            // Define the collection path (Public data for opportunities)
            opportunitiesCollectionRef = collection(db, `artifacts/${appId}/public/data/opportunities`);

            // Start the initial load
            fetchOpportunities();

        } catch (error) {
            console.error("Firebase authentication failed:", error);
        }
    }

    // --- DATA RENDERING ---

    function renderOpportunityCard(opportunity) {
        // Simple card structure based on OpportunityPage fields
        const feesDisplay = opportunity.fees > 0
            ? `$${opportunity.fees.toFixed(2)}`
            : 'Free';

        const locationType = opportunity.online_offline.charAt(0).toUpperCase() + opportunity.online_offline.slice(1);
        const programType = opportunity.program_type.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');

        // Placeholder image since Wagtail image URLs are not available here
        const imageUrl = `https://placehold.co/400x200/4CAF50/ffffff?text=${programType}`;

        return `
            <div class="col-md-6 col-lg-4 opportunity-card-item">
                <div class="card h-100 shadow-sm border-0 rounded-lg overflow-hidden">
                    <img src="${imageUrl}" class="card-img-top" alt="${opportunity.title}">
                    <div class="card-body d-flex flex-column">
                        <span class="badge bg-primary-green text-white mb-2 align-self-start">${programType}</span>
                        <h5 class="card-title fw-bold">${opportunity.title}</h5>
                        <p class="card-text small text-muted">${opportunity.overview ? opportunity.overview.substring(0, 100) + '...' : 'No overview available.'}</p>
                        <div class="mt-auto pt-3 border-top">
                            <p class="mb-1 small">
                                <i class="bi bi-geo-alt-fill text-dark-blue me-2"></i> 
                                ${locationType} (${opportunity.location || 'N/A'})
                            </p>
                            <p class="mb-0 small">
                                <i class="bi bi-currency-dollar text-dark-blue me-2"></i> 
                                ${feesDisplay}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // --- QUERY LOGIC ---

    async function fetchOpportunities() {
        if (!opportunitiesCollectionRef) return;

        // 1. Get current filter values
        const filters = getActiveFilters();

        let q = query(opportunitiesCollectionRef);
        let results = [];

        loadingSpinner.classList.remove('d-none');
        opportunityList.innerHTML = '';
        noResultsMessage.classList.add('d-none');
        resultCount.textContent = 0;

        try {
            // NOTE: Firestore queries are limited to AND logic and inequality constraints on a single field.
            // We fetch all opportunities and use client-side filtering for complex requirements (like age range and text search).

            // Apply simple equality filters (Program Type is the best candidate for initial Firestore filtering)
            if (filters.program_type.length > 0) {
                // If multiple program types are selected, use 'in' query.
                if (filters.program_type.length <= 10) { // Firestore limit for 'in' is 10
                    q = query(q, where('program_type', 'in', filters.program_type));
                }
            }

            // Execute the initial Firestore query
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach(doc => {
                results.push({ id: doc.id, ...doc.data() });
            });

            // 2. Client-side filtering for complex/unsupported queries (e.g., text search, numerical ranges)
            let filteredResults = results.filter(opportunity => {
                let matches = true;

                // Client-side text search (title and overview)
                if (filters.search_text) {
                    const searchLower = filters.search_text.toLowerCase();
                    const titleLower = opportunity.title ? opportunity.title.toLowerCase() : '';
                    const overviewLower = opportunity.overview ? opportunity.overview.toLowerCase() : '';
                    if (!titleLower.includes(searchLower) && !overviewLower.includes(searchLower)) {
                        matches = false;
                    }
                }

                // Client-side Online/Offline Filter
                if (matches && filters.online_offline && filters.online_offline !== 'all') {
                    if (opportunity.online_offline !== filters.online_offline) {
                        matches = false;
                    }
                }

                // Client-side Fees Filter
                if (matches) {
                    if (filters.fees === 'free' && opportunity.fees > 0) {
                        matches = false;
                    } else if (filters.fees === 'paid' && (opportunity.fees === 0 || opportunity.fees === null)) {
                        matches = false;
                    }
                }

                // Client-side Program Type Filter (only needed if too many were selected for the Firestore 'in' clause, or to reinforce)
                if (matches && filters.program_type.length > 10) {
                    if (!filters.program_type.includes(opportunity.program_type)) {
                        matches = false;
                    }
                }

                // NOTE: Age filtering (min_age/max_age) logic would also be applied here if needed.

                return matches;
            });

            // 3. Render results
            if (filteredResults.length > 0) {
                const html = filteredResults.map(renderOpportunityCard).join('');
                opportunityList.innerHTML = html;
                resultCount.textContent = filteredResults.length;
            } else {
                noResultsMessage.classList.remove('d-none');
                resultCount.textContent = 0;
            }

        } catch (error) {
            console.error("Error fetching opportunities:", error);
            noResultsMessage.textContent = "Error loading opportunities. Please try again later.";
            noResultsMessage.classList.remove('d-none');
        } finally {
            loadingSpinner.classList.add('d-none');
        }
    }

    // --- FILTER UTILITIES ---

    function getActiveFilters() {
        const filters = {
            program_type: [],
            online_offline: null,
            fees: null,
            search_text: searchText.value.trim().toLowerCase(),
        };

        // Checkboxes for Program Type
        document.querySelectorAll('input[data-filter-group="program_type"]:checked').forEach(input => {
            filters.program_type.push(input.value);
        });

        // Radio buttons for Location Type
        const onlineOfflineChecked = document.querySelector('input[name="online_offline"]:checked');
        if (onlineOfflineChecked) {
            filters.online_offline = onlineOfflineChecked.value;
        }

        // Radio buttons for Fees
        const feesChecked = document.querySelector('input[name="fees"]:checked');
        if (feesChecked) {
            filters.fees = feesChecked.value;
        }

        return filters;
    }

    // --- EVENT LISTENERS ---

    // Debounce the text search input
    searchText.addEventListener('input', debounce(fetchOpportunities, 500));

    // Re-fetch opportunities whenever a filter input changes
    filterForm.addEventListener('change', (event) => {
        if (event.target.classList.contains('filter-input')) {
            fetchOpportunities();
        }
    });

    // Clear filters should trigger a fetch to reload all items
    filterForm.addEventListener('reset', (event) => {
        // Since reset happens instantly, we delay the fetch slightly
        setTimeout(fetchOpportunities, 10);
    });

    // Start the application
    initializeFirebase();

</script>
{% endblock content %}