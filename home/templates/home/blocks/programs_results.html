{% load static wagtailcore_tags wagtailimages_tags filters %}

<!-- 
<h2 class="h4 fw-normal text-dark-blue mb-4 px-4">
    Showing <span class="text-primary-green fw-bold">{{ opportunities.paginator.count }}</span> result{% if opportunities.paginator.count != 1 %}s{% endif %}
    {% if search_query %}
    for "<span class="fst-italic fw-normal">{{ search_query }}</span>"
    {% endif %}
</h2> -->

<div class="d-flex justify-content-between align-items-center mb-4 px-md-4 px-sm-2 ">
    <h2 class="h4 fw-normal text-dark-blue mb-0">
        Showing <span class="text-primary-green fw-bold">{{ opportunities.paginator.count }}</span> result{% if opportunities.paginator.count != 1 %}s{% endif %}
        {% if search_query %}
        for "<span class="fst-italic fw-normal">{{ search_query }}</span>"
        {% endif %}
    </h2>
    
    <button class="btn text-dark-blue d-md-none border-0 fs-3 p-0" 
            type="button" 
            data-bs-toggle="offcanvas" 
            data-bs-target="#offcanvasFilters">
        <i class="bi bi-filter-right"></i>
    </button>
</div>


{% if selected_filters %}
    <div class="active-filters-container mb-4 d-flex flex-wrap align-items-center gap-2 px-md-4">
        <span class="text-muted small fw-bold me-1">Active Filters:</span>
        {% for key, values in selected_filters.items %}
            {% if key != 'q' %} {# Skip the search query text if you only want category badges #}
                {% for value_slug in values %}
                    <button type="button" 
                            class="btn btn-outline-primary btn-sm rounded-pill d-flex align-items-center py-1 ps-3 pe-2 shadow-sm filter-badge"
                            onclick='$(`input[name="${name}"][value=""]`)'>
                        
                        <span class="me-2">
                            {% for field_name, filter_config in program_filters.items %}
                                {% if field_name == key or key == filter_config.title|slugify %}
                                    {% for choice in filter_config.data %}
                                        {% if choice.slug == value_slug %}{{ choice.name }}{% endif %}
                                    {% endfor %}
                                {% endif %}
                            {% endfor %}
                        </span>
                        
                        <span class="badge bg-white text-primary rounded-circle p-1 ms-1" style="width: 20px; height: 20px; line-height: 12px;">&times;</span>
                    </button>
                {% endfor %}
            {% endif %}
        {% endfor %}

        <a id="clear-all" href="{{ page.url }}#program-container" class="btn btn-link btn-sm text-danger text-decoration-none fw-bold ms-2">
            Clear All
        </a>
    </div>
    {% endif %}

{% if not opportunities.object_list %}
<div class="alert alert-info border-start border-4 border-dark-blue shadow-sm" role="alert">
    <h5 class="alert-heading fw-bold">No results found!</h5>
    <p>We couldn't find any opportunities matching your selected criteria. Please try broadening your search
        or clearing some filters.</p>
</div>
{% endif %}

{% if opportunities.object_list|length > 0 %}
<div class="col-12 col-md-12 results-section p-4">
    {% for program in opportunities.object_list %}
    <div class="result-card p-3 shadow-sm bg-white border-1 mb-4">
        <div class="row align-items-start">
            <div class="col-12 col-sm-8 col-md-8 order-2 order-sm-1">
                <p class="program-title mb-1 mt-2 mt-sm-0">{{ program.title|title }}</p>
                <p class="text-muted small mb-2 d-flex align-items-center">
                    <i class="bi bi-geo-fill me-1 pb-1"></i> 
                    <span>{{ program.city|title }}, {{ program.state|upper }}</span>
                </p>
            </div>

            <div class="col-sm-4 col-md-4 d-none d-sm-block order-1 order-sm-2">
                <div class="logo-container d-flex">
                    {% with program.logo_image as img %}
                        {% if img %}
                            {% image img width-300 as logo_img %}
                            <img src="{{ logo_img.url }}" alt="{{ program.title|title }}" class="img-fluid">
                        {% endif %}
                    {% endwith %}
                </div>
            </div>
        </div>
        
        <div class="row mt-2">
            <div class="col-12">
                <div class="small text-secondary">
                    {{ program.program_summary }}
                </div>
            </div>
        </div>
        
        <div class="row mt-3 justify-content-end">
            <div class="col-12 d-flex justify-content-end gap-2">
                <a href="{% pageurl program %}" class="btn btn-primary btn-sm btn-learn-more">
                    Learn More
                </a>
                {% if program.website %}
                <a href="{{program.website}}" target="_blank" class="btn btn-secondary btn-sm btn-website">
                    Website
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% include "includes/pagination.html" with page_obj=opportunities %}
{% endif %}