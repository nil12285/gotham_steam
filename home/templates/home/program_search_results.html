{% extends "base.html" %}
{% load static wagtailcore_tags wagtailimages_tags filters %}


{% block content %}
{% image page.hero_image fill-1440x600 as hero_img %}
<section class="hero-section text-white text-center  d-none d-md-flex  align-items-center justify-content-center" style="
        background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('{{ hero_img.url }}') center/cover no-repeat;">
    <div class="container py-5">
    </div>
</section>

<div class="feature-blocks-container d-none d-md-block">
    {% for block in page.intro %}
    {% include_block block %}
    {% endfor %}
</div>

<div id="program-container" class="container-fluid mt-4 mt-md-0 mb-5">
    <div class="row filter-section px-2 px-md-5">
        
        <div class="col-12 col-md-3 ps-md-5">
            <div class="offcanvas-md offcanvas-start ps-md-4" tabindex="-1" id="offcanvasFilters">
                
                <div class="offcanvas-header d-md-none border-bottom bg-light">
                    <h5 class="offcanvas-title fw-bold text-dark-blue">CHOOSE PROGRAMS</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#offcanvasFilters"></button>
                </div>
                
                <div class="offcanvas-body p-3 p-md-0 ps-md-4">
                    <div id="accordionProgramFilter" class="accordion w-95">
                        <h3 class="fw-bold text-dark-blue text-center pt-4 d-none d-md-block">CHOOSE PROGRAMS</h3>
                        <form id="program-filter-form" method="GET">
                            {% for key, filter in program_filters.items %}
                            <div class="accordion-item mb-2 border-0 rounded-0">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse_{{key}}" aria-expanded="false" aria-controls="collapse_{{key}}">
                                        {{filter.title|upper}}
                                    </button>
                                </h2>
                                <div id="collapse_{{key}}" class="accordion-collapse collapse" data-bs-parent="#accordionProgramFilter">
                                    <div class="accordion-body">
                                        {% for choice in filter.data %}
                                            <div class="form-check">
                                                <input id="type-{{ choice.slug }}" name="{{key}}" 
                                                    class="form-check-input filter-input"
                                                    value="{{ choice.slug }}" 
                                                    type="checkbox" 
                                                    {% if choice.slug in selected_filters|lookup:key %}checked{% endif %}/>
                                                <label for="type-{{ choice.slug }}" class="form-check-label small">
                                                    {{ choice.name }}
                                                </label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Search Results (Right Column) -->
        <div class="col-12 col-md-9 results-section p-3 p-md-4">
            <div id="results-container"> 
                {% include "home/blocks/programs_results.html" %}
            </div>
        </div>
        
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
    function removeFilter(name, value) {
        $(`input[name="${name}"][value="${value}"]`).prop('checked', false).trigger('change');
    }

    $(document).ready(function() {
        const $filterForm = $('#program-filter-form');
        const $resultsContainer = $('#results-container'); // Ensure this ID exists around your results list

        /**
         * core function to update results via AJAX
         */
        function updateResults(url = null) {            
            $resultsContainer.css('opacity', '0.5');
            
            if (!url) {
                const formData = $filterForm.serialize();
                url = `${window.location.pathname}?${formData}`;
            }
            
            $.ajax({
                url: url,
                success: function(html) {
                    $resultsContainer.html(html);
                    $resultsContainer.css('opacity', '1');
                    window.history.pushState({ path: url }, '', url);
                    
                    if ($(window).width() < 768) {
                        $('html, body').animate({ scrollTop: $resultsContainer.offset().top - 100 }, 200);
                    }
                },
                error: function(xhr) {
                    console.error("Filtering failed", xhr);
                    $resultsContainer.css('opacity', '1');
                }
            });
        }

        
        const $slider = $('#age-range-slider');
        const $output = $('#age-value');
        if ($slider.length) {
            $slider.on('input', function() {
                $output.html(this.value);
            });
        }

        
        $filterForm.on('change', 'input, select', function(e) {
            const offcanvasElement = document.getElementById('offcanvasFilters');
            const bsOffcanvas = bootstrap.Offcanvas.getInstance(offcanvasElement);
            
            if (window.innerWidth < 768 && bsOffcanvas) {
                bsOffcanvas.hide(); // Close menu after selection
            }
            
            if ($(e.target).attr('name') !== 'q') {
                updateResults();
            }
        });

        
        let searchTimeout;
        $('#id_q').on('keyup', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() {
                updateResults();
            }, 500); 
        });

        
        $('#id_q').on('keypress', function(e) {
            if (e.which === 13) { 
                e.preventDefault();
                updateResults();
            }
        });

        
        $(document).on('click', '.pagination a', function(e) {
            e.preventDefault();
            const url = $(this).attr('href');
            if (url) {
                updateResults(url);
            }
        });

        
        $('.collapse').on('show.bs.collapse', function () {
            $(`[data-bs-target="#${this.id}"] i.bi-chevron-down`).addClass('rotate-up').removeClass('collapsed');
        }).on('hide.bs.collapse', function () {
            $(`[data-bs-target="#${this.id}"] i.bi-chevron-down`).removeClass('rotate-up').addClass('collapsed');
        });
    });
</script>

{% endblock extra_js %}